<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>基因检测申请表</title>
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
<meta name="format-detection" content="telephone=no,email=no">
<meta http-equiv="Cache-Control" content="no-store" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="HandheldFriendly" content="true">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<link rel="stylesheet"
	href="http://cdn.bootcss.com/weui/1.1.1/style/weui.min.css">
<link rel="stylesheet"
	href="http://cdn.bootcss.com/jquery-weui/1.0.1/css/jquery-weui.min.css">
<link href='${system_css}/jcsq.css' rel='stylesheet'>
</head>
<body ontouchstart style="background-color: white;">
	<header class="header-warp">
		<h1 class="title">
				<img src="${system_images}/title.png" alt="基因检测申请表">
		</h1>
		<article class="letter-box" style="margin-top: 1em;">
			<p>尊敬的客户：</p>
			<p>
				您好，为了给您提供一次良好的基因检测服务体验，请您真实填写以下个人信息。<span class="ntc-red">（注：基因信息涉及您的个人隐私，我们将对您的检测记录和个人资料严格保密！）</span>
			</p>
			<p>谢谢您的配合！</p>

		</article>
	</header>
	<article>
		<form action="" class="my-form" id='cm_form'>
			<input type='hidden' name="agency.id" value="${agencyId!?html}" />
			<input type='hidden' name="agencyAccountId" value="${agencyAccountId!?html}" />
			<input type='hidden' name="reportPrintRequired" value="0"/>
			<input type='hidden' name="sampleType" value="1"/>
			<input type='hidden' name="customer.province" class="address"/>
			<input type='hidden' name="customer.city" class="address"/>
			<input type='hidden' name="customer.county" class="address"/>
			<div class="input-group">
				<label for="" class="input-label"><span>1.条码编号</span></label>
				<div class="input-controls">
					<input type="text" class="input-txt" name='code'>
				</div>
			</div>
			<div class="input-group">
				<label for="" class="input-label"><span>2.检测项目</span></label>
				<div class="input-controls">
					<input type="text" readonly class="input-txt" id="packagesId"
						onchange='getpackagesId(this)'> <input type="hidden"
						class="input-txt" name="product.id" value=''>
				</div>
			</div>
			<div class="input-group">
				<label for="" class="input-label"><span>3.姓名</span></label>
				<div class="input-controls">
					<input type="text" class="input-txt" name="customer.name">
				</div>
			</div>
			<div class="input-group">
				<label for="" class="input-label"><span>4.性别</span></label>
				<div class="input-controls weui-cells_checkbox">
					<label class="weui-check__label my-check_label"> <input
						type="radio" class="weui-check" name="customer.sex" value='1'> <i
						class="weui-icon-checked"></i> <span style="margin-left: 0.5em;">男</span>
					</label> <label class="weui-check__label my-check_label"
						style="margin-left: 3em;"> <input type="radio"
						class="weui-check" name="customer.sex" value='2'> <i
						class="weui-icon-checked"></i> <span style="margin-left: 0.5em;">女</span>
					</label>
				</div>
			</div>
			<div class="input-group">
				<label for="" class="input-label"><span>5.出生日期</span></label>
				<div class="input-controls">
					<input type="text" readonly class="input-txt" id="birth"
						name='customer.birthday'>
				</div>
			</div>
			<div class="input-group">
				<label for="" class="input-label"><span>6.手机号码</span></label>
				<div class="input-controls">
					<input type="tel" class="input-txt" name="customer.phone" />
				</div>
			</div>
			<div class="input-group">
				<label for="" class="input-label"><span>7.邮箱</span></label>
				<div class="input-controls">
					<input type="email" class="input-txt" name="customer.email" />
				</div>
			</div>
			<div class="input-group">
				<label for="sickCity" class="input-label"><span>8.地址</span></label>
				<div class="input-controls">
					<input type="text" placeholder="选择地址" class="input-txt" id="sickCity" name='address' />
				</div>
				<div class="input-controls">
					<textarea name='customer.address' rows="3" class="input-txt" placeholder="街道信息"></textarea>
				</div>
			</div>
			<div class="xy-box">
				<div class="xy-title-box">
					<h4>知情同意书</h4>
				</div>
				<p>一、遗传只是与疾病相关的因素之一，每个人的健康情况也受到环境的影响。基因检测结果提供的只是您与生俱来的遗传特性，提供的检测报告也只是罹患某种疾病几率的高低，这些结果不能等同于医学检测报告，也不构成临床疾病诊断的依据。</p>
				<p>二、若检测报告中显示某种疾病风险高，并不等于您的一生中一定会罹患该病；分析的目的仅在于您能针对自己的遗传特性来提高警觉，不能代替任何临床医学服务。</p>
			</div>
			<div class="weui-cells_checkbox weui-flex"
				style="margin: 1em -0.5em 2em;">
				<label class="weui-check__label my-check_label weui-flex__item">
					<input type="checkbox" class="weui-check"> <i
					class="weui-icon-checked"></i> <span style="font-size: 0.8125em;">本人已阅读以上内容，明确知悉并同意以上内容。</span>
				</label>
			</div>
			<div class="submit-box weui-flex">
				<div class="weui-flex__item">
					<button type="button" class="weui-btn submit-btn" id="subBtn">提
						交</button>
				</div>

			</div>
		</form>
	</article>
	<script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
	<script type="text/javascript" src="http://cdn.staticfile.org/fastclick/1.0.6/fastclick.min.js"></script>
	<script src="//cdn.bootcss.com/jquery-weui/1.0.1/js/jquery-weui.min.js"></script>
	<script src="${system_js}/city-picker.min.js"></script>
	<script type="text/javascript" src="${system_js}/datetime-picker2.js"></script>
	<script type="text/javascript" src="${plugins}/layer/layer.min.js"></script>
	<script type="text/javascript">
var arr = [];
<#if datas?has_content>
arr = ${datas}
</#if>

$("#packagesId").select({
	title : "检测项目",
	multi : false,
	items:arr
	});

$("#birth").datetimePicker({
	yearSplit : '-',
	monthSplit : '-',
	max:new Date(),
	times : function() {
		return null;
	}
});

    // 城市
    $('#sickCity').cityPicker({
        title: '选择您的城市',
		onChange:function(picker,values,dispalyValues)
		{
		    $(".address").each(function(i,v){
		        $(v).val(values[i])
            });
		}
    });

    //提交验证
    $('#subBtn').on('click',function(e){
       var $me = $(this);
        $me.attr('disabled',true);
        if(yz()) {
            var code = $.trim($('input.input-txt:first').val());
            $.ajax({
            	type:'GET',
            	url:'${base}/order/validateCode.do?code='+code,
                success:function(flag){
                	if(flag){
                		$.ajax({
							cache : true,
							type : "POST",
							url : '${base}/order/crateOrderAtMoble.do',
							data : $('#cm_form').serialize(),
							async : false,
							error : function(request) {
								console.log(request)
								alert("Connection error");
							},
							success : function(data) {
								layer.confirm('您已经成功提交该订单！', { btn: ['确定','取消']}, function(){
									layer.closeAll('dialog');
									window.location.href = '${base}/order/redirectMobileHtml.do?agencyId='
										+ data
								});
							}
						});
                	}else{
                		$.toptip('条码编号已存在', 'error');
                        $('.input-group:first').addClass('error');
                        $me.attr('disabled',false);
                	}
                },
                error: function (){
                    alert('some error!');
                }
            });
        }else {
            $me.attr('disabled',false);
        }
    });

    $('.input-txt').on('click input change propertychange',function(e){
        var $me = $(this);
        setInputState($me);
        if($me.get(0) == $('#sickCity').get(0) && !$me.is(':focus')){
        	$(':focus').blur();
        	return false;
        }
    });

    $('input:radio').on('focus input change propertychange',function(e){
        var $me = $(this);
        var $group = $me.closest('.input-group');
        $group.addClass('active').siblings('.input-group').removeClass('active');
        if($group.hasClass('error')){
            $group.removeClass('error');
        }
    });

    function setInputState($inputTxt) {
        var $group = $inputTxt.closest('.input-group');
        if($group.hasClass('error')){
            $group.removeClass('error');
        }
        $group.addClass('active').siblings('.input-group').removeClass('active');
    }
    function yz() {
        var isRigth = true;
        $('.input-group:not(:last)').each(function(index){
            var $me = $(this);
            var label = $me.find('.input-label span').text();
            var $input = $me.find('input.input-txt');
            if($input.length > 0){
                var crt_v = $.trim($input.val());
                if(crt_v.length <=0){
                    isRigth = false;
                    $.toptip(label + '--信息不能为空!', 'error');
                    $me.addClass('error');
                    return false;
                }else{
                	var $birth = $('#birth');
                   	if($birth.get(0) == $input.get(0)){
	                   	 var now = new Date();
	                     var d = new Date(crt_v);
	                     if (d >= now ) {
	                    	 isRigth = false;
	                     	$.toptip(label + '--出身日期不大于今天', 'error');
	                     	$me.addClass('error');
	                         return false
	                     }
                   	}

                    var type = $input.attr('type');
                    if(type=='tel'){
                        if (!/^\d{11}$/g.test(crt_v)) {
                            isRigth = false;
                            $.toptip(label + '--手机格式有误', 'error');
                            $me.addClass('error');
                            return false;
                        }
                    }
                }
            }else{
                if($me.find('input:radio:checked').length <= 0){
                    isRigth = false;
                    $.toptip(label + '--请确定', 'error');
                    $me.addClass('error');
                    return false;
                }
            }
        });

        if(isRigth){
            var $group = $('.input-group:last');
            var $input = $group.find('input.input-txt');
            var $textarea = $group.find('textarea');
            var label = $group.find('.input-label span').text();
            var city = $.trim($input.val());
            var street = $.trim($textarea.val());
            if(city<=0){
                isRigth = false;
                $.toptip(label + '--请确定省市区域', 'error');
                $group.addClass('error');
            }else{
                if(street<=0){
                    isRigth = false;
                    $.toptip(label + '--请填写详细地址', 'error');
                    $group.addClass('error');
                }
            }
        }
        if(isRigth){
            var $checkbox = $('input:checkbox');
            if(!$checkbox.prop('checked')){
                isRigth = false;
                $.toptip( '请确定是否接受《知情同意书》', 'error');
            }
        }

        return isRigth;
    }

    function getpackagesId(obj){
    	var val_ = $(obj).attr('data-values')
    	$('input[name="product.id"]').val(val_ )
    };



</script>
</body>
</html>